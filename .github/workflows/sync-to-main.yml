name: Sync Student Data to Main Portfolio

on:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all profiles'
        required: false
        default: 'false'
        type: boolean
  push:
    branches: [ main ]
    paths:
      - 'data/**/*.md'
      - 'data/**/*.jpg'
      - 'data/**/*.jpeg'
      - 'data/**/*.png'
      - 'data/**/*.webp'
      - 'data/**/*.pdf'
      - 'scripts/**/*.py'

permissions:
  contents: write

jobs:
  sync-to-main:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout regis_std repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Check if PAT_TOKEN exists
      run: |
        if [ -z "${{ secrets.PAT_TOKEN }}" ]; then
          echo "‚ùå PAT_TOKEN secret not found"
          echo "Please add PAT_TOKEN as a repository secret"
          exit 1
        else
          echo "‚úÖ PAT_TOKEN secret found"
        fi
        
    - name: Install image optimization tools
      run: |
        sudo apt-get update
        sudo apt-get install -y webp imagemagick
        echo "‚úÖ Image optimization tools installed"
        
    - name: Optimize student images
      run: |
        echo "üñºÔ∏è  Starting image optimization..."
        
        # Initialize counter
        image_count=0
        
        # Function to optimize images
        optimize_image() {
          local input_file="$1"
          local dir=$(dirname "$input_file")
          local filename=$(basename "$input_file")
          local name="${filename%.*}"
          local ext="${filename##*.}"
          
          echo "  üì∏ Processing: $input_file"
          
          # Handle profile_avatar specifically
          if [[ "$name" == "profile_avatar" ]]; then
            # Create optimized avatar.webp (200x200 for profile photos)
            cwebp -q 90 -resize 200 200 "$input_file" -o "${dir}/avatar.webp"
            echo "    ‚úÖ Created avatar.webp (200x200)"
            
            # Also create a regular avatar.jpg for fallback
            convert "$input_file" -resize 200x200^ -gravity center -extent 200x200 "${dir}/avatar.jpg"
            echo "    ‚úÖ Created avatar.jpg (200x200)"
            
            # Remove original profile_avatar file
            rm "$input_file"
            echo "    üóëÔ∏è  Removed original profile_avatar file"
            
          elif [[ "$name" == "avatar" ]]; then
            # Handle existing avatar files
            cwebp -q 90 -resize 200 200 "$input_file" -o "${dir}/avatar.webp"
            echo "    ‚úÖ Optimized existing avatar to WebP"
            
          else
            # Handle other images (project images, etc.)
            cwebp -q 85 -resize 800 600 "$input_file" -o "${dir}/${name}.webp"
            echo "    ‚úÖ Optimized ${name} to WebP (800x600)"
            
            # Keep original for now (students might reference it)
            # Optionally: rm "$input_file" to remove original
          fi
          
          return 0
        }
        
        # Find and process all images - fixed the loop issue
        if find data/ -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) -print0 | grep -zq .; then
          while IFS= read -r -d '' file; do
            optimize_image "$file"
            image_count=$((image_count + 1))
          done < <(find data/ -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) -print0)
          
          echo "üìä Successfully processed $image_count images"
        else
          echo "üì∑ No images found to optimize"
        fi
        
    - name: Commit optimized images
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - Image Optimizer"
        git add data/
        
        if git diff --staged --quiet; then
          echo "üì∑ No image changes to commit"
        else
          git commit -m "üñºÔ∏è Optimize images: Convert profile_avatar.jpg to avatar.webp and avatar.jpg"
          git push origin main
          echo "‚úÖ Pushed optimized images"
        fi
        
    - name: Checkout main portfolio repository
      uses: actions/checkout@v4
      with:
        repository: 'iamgmujtaba/regis'
        token: ${{ secrets.PAT_TOKEN }}
        path: 'main-portfolio'
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyYAML
        echo "‚úÖ Python dependencies installed"
        
    - name: Sync student data and generate profiles
      run: |
        echo "üîÑ Starting student data sync..."
        python scripts/sync-to-portfolio.py
        
    - name: Verify generated files
      run: |
        echo "üìã Verifying generated files..."
        
        # Check if profiles directory exists and has files
        if [ -d "main-portfolio/profiles" ]; then
          profile_count=$(find main-portfolio/profiles -name "*.html" | wc -l)
          echo "‚úÖ Generated $profile_count profile pages"
          
          # List generated profiles
          echo "üìÑ Generated profiles:"
          find main-portfolio/profiles -name "*.html" -exec basename {} .html \; | sort
        else
          echo "‚ö†Ô∏è No profiles directory found"
        fi
        
        # Check if semester data file exists
        if [ -f "main-portfolio/data/students_msds696_s71.json" ]; then
          echo "‚úÖ Semester data file created"
          # Show student count (only if jq is available)
          if command -v jq >/dev/null 2>&1; then
            student_count=$(jq '.students | length' main-portfolio/data/students_msds696_s71.json)
            echo "üìä Processed $student_count students"
          fi
        else
          echo "‚ö†Ô∏è Semester data file not found"
        fi
        
    - name: Commit and push to main portfolio
      run: |
        cd main-portfolio
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - Portfolio Sync"
        
        # Add all generated files
        git add profiles/ || true
        git add data/ || true
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "üìù No changes to commit to main portfolio"
        else
          # Get some stats for the commit message
          if [ -f "data/students_msds696_s71.json" ]; then
            if command -v jq >/dev/null 2>&1; then
              student_count=$(jq '.students | length' data/students_msds696_s71.json 2>/dev/null || echo "unknown")
            else
              student_count="unknown"
            fi
            commit_msg="üéì Auto-sync: Updated $student_count student profiles - $(date +'%Y-%m-%d %H:%M UTC')"
          else
            commit_msg="üéì Auto-sync: Updated student data - $(date +'%Y-%m-%d %H:%M UTC')"
          fi
          
          git commit -m "$commit_msg"
          git push origin main
          echo "‚úÖ Successfully pushed updates to main portfolio"
          
          # Show what was updated
          echo "üìä Update summary:"
          git show --stat HEAD~1..HEAD || echo "Unable to show stats"
        fi
        
    - name: Generate summary report
      run: |
        echo "üìã === SYNC SUMMARY REPORT ===" 
        echo "‚è∞ Sync completed at: $(date)"
        echo ""
        
        # Count students processed
        if [ -f "main-portfolio/data/students_msds696_s71.json" ]; then
          if command -v jq >/dev/null 2>&1; then
            student_count=$(jq '.students | length' main-portfolio/data/students_msds696_s71.json)
            echo "üë• Students processed: $student_count"
            
            # List students
            echo "üìã Student list:"
            jq -r '.students[] | "  - " + .name + " (" + .username + ")"' main-portfolio/data/students_msds696_s71.json | sort
          else
            echo "üë• Students processed: (jq not available for count)"
          fi
        fi
        
        echo ""
        
        # Count profile pages
        if [ -d "main-portfolio/profiles" ]; then
          profile_count=$(find main-portfolio/profiles -name "*.html" | wc -l)
          echo "üìÑ Profile pages generated: $profile_count"
        fi
        
        echo ""
        
        # Show URLs where profiles will be available
        echo "üåê Profile URLs (after GitHub Pages deployment):"
        if [ -d "main-portfolio/profiles" ]; then
          find main-portfolio/profiles -name "*.html" -exec basename {} .html \; | sort | while read username; do
            echo "  - https://gmujtaba.com/regis/profiles/$username.html"
          done
        fi
        
        echo ""
        echo "‚úÖ Sync completed successfully!"
        
    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå === SYNC FAILED ===" 
        echo "‚è∞ Failed at: $(date)"
        echo ""
        echo "üîç Check the logs above for error details"
        echo "üí° Common issues:"
        echo "  - PAT_TOKEN not set or expired"
        echo "  - Malformed markdown in student profiles"
        echo "  - Missing required files"
        echo "  - Network connectivity issues"
        echo ""
        echo "üõ†Ô∏è  To fix:"
        echo "  1. Check repository secrets (PAT_TOKEN)"
        echo "  2. Validate student markdown files"
        echo "  3. Re-run the workflow"