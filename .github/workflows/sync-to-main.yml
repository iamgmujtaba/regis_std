name: Sync Student Data to Main Portfolio

on:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all profiles'
        required: false
        default: 'false'
        type: boolean
  push:
    branches: [ main ]
    paths:
      - 'data/**/*.md'
      - 'data/**/*.jpg'
      - 'data/**/*.jpeg'
      - 'data/**/*.png'
      - 'data/**/*.webp'
      - 'data/**/*.pdf'
      - 'scripts/**/*.py'

permissions:
  contents: write

jobs:
  sync-to-main:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout regis_std repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Check if PAT_TOKEN exists
      run: |
        if [ -z "${{ secrets.PAT_TOKEN }}" ]; then
          echo "âŒ PAT_TOKEN secret not found"
          echo "Please add PAT_TOKEN as a repository secret"
          exit 1
        else
          echo "âœ… PAT_TOKEN secret found"
        fi
        
    - name: Install image optimization tools
      run: |
        sudo apt-get update
        sudo apt-get install -y webp imagemagick
        echo "âœ… Image optimization tools installed"
        
    - name: Optimize student images
      run: |
        echo "ğŸ–¼ï¸  Starting image optimization..."
        
        # Function to optimize images
        optimize_image() {
          local input_file="$1"
          local dir=$(dirname "$input_file")
          local filename=$(basename "$input_file")
          local name="${filename%.*}"
          local ext="${filename##*.}"
          
          echo "  ğŸ“¸ Processing: $input_file"
          
          # Handle profile_avatar specifically
          if [[ "$name" == "profile_avatar" ]]; then
            # Create optimized avatar.webp (200x200 for profile photos)
            cwebp -q 90 -resize 200 200 "$input_file" -o "${dir}/avatar.webp"
            echo "    âœ… Created avatar.webp (200x200)"
            
            # Also create a regular avatar.jpg for fallback
            convert "$input_file" -resize 200x200^ -gravity center -extent 200x200 "${dir}/avatar.jpg"
            echo "    âœ… Created avatar.jpg (200x200)"
            
            # Remove original profile_avatar file
            rm "$input_file"
            echo "    ğŸ—‘ï¸  Removed original profile_avatar file"
            
          elif [[ "$name" == "avatar" ]]; then
            # Handle existing avatar files
            cwebp -q 90 -resize 200 200 "$input_file" -o "${dir}/avatar.webp"
            echo "    âœ… Optimized existing avatar to WebP"
            
          else
            # Handle other images (project images, etc.)
            cwebp -q 85 -resize 800 600 "$input_file" -o "${dir}/${name}.webp"
            echo "    âœ… Optimized ${name} to WebP (800x600)"
            
            # Keep original for now (students might reference it)
            # Optionally: rm "$input_file" to remove original
          fi
        }
        
        # Find and process all images
        image_count=0
        find data/ -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) | while read -r file; do
          optimize_image "$file"
          ((image_count++))
        done
        
        echo "ğŸ“Š Processed $image_count images"
        
    - name: Commit optimized images
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - Image Optimizer"
        git add data/
        
        if git diff --staged --quiet; then
          echo "ğŸ“· No image changes to commit"
        else
          git commit -m "ğŸ–¼ï¸ Optimize images: Convert profile_avatar.jpg to avatar.webp and avatar.jpg"
          git push origin main
          echo "âœ… Pushed optimized images"
        fi
        
    - name: Checkout main portfolio repository
      uses: actions/checkout@v4
      with:
        repository: 'iamgmujtaba/regis'
        token: ${{ secrets.PAT_TOKEN }}
        path: 'main-portfolio'
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyYAML
        echo "âœ… Python dependencies installed"
        
    - name: Sync student data and generate profiles
      run: |
        echo "ğŸ”„ Starting student data sync..."
        python scripts/sync-to-portfolio.py
        
    - name: Verify generated files
      run: |
        echo "ğŸ“‹ Verifying generated files..."
        
        # Check if profiles directory exists and has files
        if [ -d "main-portfolio/profiles" ]; then
          profile_count=$(find main-portfolio/profiles -name "*.html" | wc -l)
          echo "âœ… Generated $profile_count profile pages"
          
          # List generated profiles
          echo "ğŸ“„ Generated profiles:"
          find main-portfolio/profiles -name "*.html" -exec basename {} .html \; | sort
        else
          echo "âš ï¸ No profiles directory found"
        fi
        
        # Check if semester data file exists
        if [ -f "main-portfolio/data/students_msds696_s71.json" ]; then
          echo "âœ… Semester data file created"
          # Show student count
          student_count=$(jq '.students | length' main-portfolio/data/students_msds696_s71.json)
          echo "ğŸ“Š Processed $student_count students"
        else
          echo "âš ï¸ Semester data file not found"
        fi
        
    - name: Commit and push to main portfolio
      run: |
        cd main-portfolio
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - Portfolio Sync"
        
        # Add all generated files
        git add profiles/
        git add data/
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "ğŸ“ No changes to commit to main portfolio"
        else
          # Get some stats for the commit message
          if [ -f "data/students_msds696_s71.json" ]; then
            student_count=$(jq '.students | length' data/students_msds696_s71.json 2>/dev/null || echo "unknown")
            commit_msg="ğŸ“ Auto-sync: Updated $student_count student profiles - $(date +'%Y-%m-%d %H:%M UTC')"
          else
            commit_msg="ğŸ“ Auto-sync: Updated student data - $(date +'%Y-%m-%d %H:%M UTC')"
          fi
          
          git commit -m "$commit_msg"
          git push origin main
          echo "âœ… Successfully pushed updates to main portfolio"
          
          # Show what was updated
          echo "ğŸ“Š Update summary:"
          git show --stat HEAD~1..HEAD
        fi
        
    - name: Generate summary report
      run: |
        echo "ğŸ“‹ === SYNC SUMMARY REPORT ===" 
        echo "â° Sync completed at: $(date)"
        echo ""
        
        # Count students processed
        if [ -f "main-portfolio/data/students_msds696_s71.json" ]; then
          student_count=$(jq '.students | length' main-portfolio/data/students_msds696_s71.json)
          echo "ğŸ‘¥ Students processed: $student_count"
          
          # List students
          echo "ğŸ“‹ Student list:"
          jq -r '.students[] | "  - " + .name + " (" + .username + ")"' main-portfolio/data/students_msds696_s71.json | sort
        fi
        
        echo ""
        
        # Count profile pages
        if [ -d "main-portfolio/profiles" ]; then
          profile_count=$(find main-portfolio/profiles -name "*.html" | wc -l)
          echo "ğŸ“„ Profile pages generated: $profile_count"
        fi
        
        echo ""
        
        # Show URLs where profiles will be available
        echo "ğŸŒ Profile URLs (after GitHub Pages deployment):"
        if [ -d "main-portfolio/profiles" ]; then
          find main-portfolio/profiles -name "*.html" -exec basename {} .html \; | sort | while read username; do
            echo "  - https://gmujtaba.com/regis/profiles/$username.html"
          done
        fi
        
        echo ""
        echo "âœ… Sync completed successfully!"
        
    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ === SYNC FAILED ===" 
        echo "â° Failed at: $(date)"
        echo ""
        echo "ğŸ” Check the logs above for error details"
        echo "ğŸ’¡ Common issues:"
        echo "  - PAT_TOKEN not set or expired"
        echo "  - Malformed markdown in student profiles"
        echo "  - Missing required files"
        echo "  - Network connectivity issues"
        echo ""
        echo "ğŸ› ï¸  To fix:"
        echo "  1. Check repository secrets (PAT_TOKEN)"
        echo "  2. Validate student markdown files"
        echo "  3. Re-run the workflow"