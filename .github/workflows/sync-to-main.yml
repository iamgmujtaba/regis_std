name: Sync Student Profiles to Main Portfolio

on:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all profiles'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write

jobs:
  sync-to-main:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout regis_std repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Check if PAT_TOKEN exists
      run: |
        if [ -z "${{ secrets.PAT_TOKEN }}" ]; then
          echo "‚ùå PAT_TOKEN secret not found"
          echo "Please add PAT_TOKEN as a repository secret"
          exit 1
        else
          echo "‚úÖ PAT_TOKEN secret found"
        fi
        
    - name: Cache apt packages
      uses: actions/cache@v4
      with:
        path: |
          /var/cache/apt/archives/*.deb
        key: ${{ runner.os }}-apt-imagetools-${{ hashFiles('.github/workflows/sync-to-main.yml') }}
        restore-keys: |
          ${{ runner.os }}-apt-imagetools-
          ${{ runner.os }}-apt-
          
    - name: Detect student profile updates
      run: |
        echo "üîç Detecting updated student profiles..."
        
        # Check if there are any student profile files
        if find data/ -name "profile.md" -type f | grep -q .; then
          profile_count=$(find data/ -name "profile.md" -type f | wc -l)
          echo "ÔøΩ Found $profile_count student profiles to sync"
          
          # List recently updated profiles (if git history available)
          echo ""
          echo "üìù Student profiles found:"
          find data/ -name "profile.md" -type f | while read profile; do
            course=$(echo "$profile" | cut -d'/' -f2)
            username=$(echo "$profile" | cut -d'/' -f3)
            echo "  - $username ($course)"
          done
        else
          echo "‚ö†Ô∏è  No student profiles found - nothing to sync"
          echo "‚ÑπÔ∏è  Students need to:"
          echo "     1. Edit their profile.md files"
          echo "     2. Add their photos and project files"
          echo "     3. Commit and push changes"
          exit 0
        fi
    - name: Install image optimization tools
      run: |
        sudo apt-get update
        sudo apt-get install -y webp imagemagick
        echo "‚úÖ Image optimization tools installed"
        
    - name: Install Python dependencies  
      run: |
        python -m pip install --upgrade pip
        pip install PyYAML
        echo "‚úÖ Python dependencies installed"
        
    - name: Optimize student images
      run: |
        echo "üñºÔ∏è  Starting image optimization..."
        
        # Initialize counter
        image_count=0
        
        # Function to optimize images
        optimize_image() {
          local input_file="$1"
          local dir=$(dirname "$input_file")
          local filename=$(basename "$input_file")
          local name="${filename%.*}"
          local ext="${filename##*.}"
          
          echo "  üì∏ Processing: $input_file"
          
          # Handle profile_avatar specifically (uploaded by students)
          if [[ "$name" == "profile_avatar" ]]; then
            # Create optimized avatar.webp (200x200 for profile photos)
            cwebp -q 90 -resize 200 200 "$input_file" -o "${dir}/avatar.webp"
            echo "    ‚úÖ Created avatar.webp (200x200)"
            
            # Also create a regular avatar.jpg for fallback
            convert "$input_file" -resize 200x200^ -gravity center -extent 200x200 "${dir}/avatar.jpg"
            echo "    ‚úÖ Created avatar.jpg (200x200)"
            
            # Remove original profile_avatar file
            rm "$input_file"
            echo "    üóëÔ∏è  Removed original profile_avatar file"
            
          elif [[ "$name" == "avatar" ]]; then
            # Handle existing avatar files - create webp version
            if [[ "$ext" != "webp" ]]; then
              cwebp -q 90 -resize 200 200 "$input_file" -o "${dir}/avatar.webp"
              echo "    ‚úÖ Optimized existing avatar to WebP"
            fi
            
          else
            # Handle other images (project images, etc.)
            if [[ "$ext" != "webp" ]]; then
              cwebp -q 85 -resize 800 600 "$input_file" -o "${dir}/${name}.webp"
              echo "    ‚úÖ Optimized ${name} to WebP (800x600)"
            fi
          fi
          
          return 0
        }
        
        # Find and process all images - fixed the loop issue
        if find data/ -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) -print0 | grep -zq .; then
          while IFS= read -r -d '' file; do
            optimize_image "$file"
            image_count=$((image_count + 1))
          done < <(find data/ -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) -print0)
          
          echo "üìä Successfully processed $image_count images"
        else
          echo "üì∑ No images found to optimize"
        fi
        
    - name: Commit optimized images
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - Image Optimizer"
        git add data/
        
        if git diff --staged --quiet; then
          echo "üì∑ No image changes to commit"
        else
          git commit -m "üñºÔ∏è Auto-optimize images: Convert profile_avatar.jpg to avatar.webp and avatar.jpg ($(date +'%Y-%m-%d %H:%M UTC'))"
          git push origin main
          echo "‚úÖ Pushed optimized images"
        fi
        
    - name: Checkout main portfolio repository
      uses: actions/checkout@v4
      with:
        repository: 'iamgmujtaba/regis'
        token: ${{ secrets.PAT_TOKEN }}
        path: 'regis'
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          ~/.local/lib/python*/site-packages
        key: ${{ runner.os }}-python-deps-${{ hashFiles('.github/workflows/sync-to-main.yml') }}
        restore-keys: |
          ${{ runner.os }}-python-deps-
          ${{ runner.os }}-pip-
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyYAML
        echo "‚úÖ Python dependencies installed"
        
    - name: Sync student data and generate profiles
      run: |
        echo "üîÑ Starting student data sync..."
        python scripts/sync-to-portfolio.py
        
    - name: Copy JSON files to regis repository
      run: |
        echo "üìÑ Copying JSON data files to regis repository..."
        
        # Ensure regis/data directory exists
        mkdir -p regis/data
        
        # Copy JSON files if they exist
        if [ -f "data/2025_summer_msds692.json" ]; then
          cp data/2025_summer_msds692.json regis/data/
          echo "‚úÖ Copied MSDS692 JSON file"
        else
          echo "‚ö†Ô∏è MSDS692 JSON file not found"
        fi
        
        if [ -f "data/2025_summer_msds696.json" ]; then
          cp data/2025_summer_msds696.json regis/data/
          echo "‚úÖ Copied MSDS696 JSON file"
        else
          echo "‚ö†Ô∏è MSDS696 JSON file not found"
        fi
        
    - name: Verify generated files
      run: |
        echo "üìã Verifying generated files..."
        
        # Check if profiles directory exists and has files
        if [ -d "regis/profiles" ]; then
          profile_count=$(find regis/profiles -name "*.html" | wc -l)
          echo "‚úÖ Generated $profile_count profile pages"
          
          # List generated profiles
          echo "üìÑ Generated profiles:"
          find regis/profiles -name "*.html" -exec basename {} .html \; | sort
        else
          echo "‚ö†Ô∏è No profiles directory found"
        fi
        
        # Check if course data files exist (new naming convention)
        if [ -d "regis/data" ]; then
          data_files=$(find regis/data -name "2025_summer_*.json" 2>/dev/null || echo "")
          if [ ! -z "$data_files" ]; then
            echo "‚úÖ Course data files created:"
            for file in $data_files; do
              basename "$file"
              # Show student count if jq is available
              if command -v jq >/dev/null 2>&1; then
                student_count=$(jq '.students | length' "$file" 2>/dev/null || echo "unknown")
                echo "   üìä Contains $student_count students"
              fi
            done
          else
            echo "‚ö†Ô∏è No course data files found"
          fi
        fi
        
    - name: Commit and push to main portfolio
      run: |
        cd regis
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - Portfolio Sync"
        
        # Add all generated files
        git add profiles/ || true
        git add data/ || true
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "üìù No changes to commit to main portfolio"
        else
          # Get some stats for the commit message
          if [ -f "data/2025_summer_msds692.json" ] || [ -f "data/2025_summer_msds696.json" ]; then
            student_count=0
            if [ -f "data/2025_summer_msds692.json" ] && command -v jq >/dev/null 2>&1; then
              count692=$(jq '.students | length' data/2025_summer_msds692.json 2>/dev/null || echo 0)
              student_count=$((student_count + count692))
            fi
            if [ -f "data/2025_summer_msds696.json" ] && command -v jq >/dev/null 2>&1; then
              count696=$(jq '.students | length' data/2025_summer_msds696.json 2>/dev/null || echo 0)
              student_count=$((student_count + count696))
            fi
            commit_msg="üéì Auto-sync: Updated $student_count student profiles - $(date +'%Y-%m-%d %H:%M UTC')"
          else
            commit_msg="üéì Auto-sync: Updated student data - $(date +'%Y-%m-%d %H:%M UTC')"
          fi
          
          git commit -m "$commit_msg"
          git push origin main
          echo "‚úÖ Successfully pushed updates to main portfolio"
          
          # Show what was updated
          echo "üìä Update summary:"
          git show --stat HEAD~1..HEAD || echo "Unable to show stats"
        fi
        
    - name: Generate summary report
      run: |
        echo "üìã === SYNC SUMMARY REPORT ===" 
        echo "‚è∞ Sync completed at: $(date)"
        echo ""
        
        # Count students processed from both courses
        total_students=0
        
        if [ -f "regis/data/2025_summer_msds692.json" ] && command -v jq >/dev/null 2>&1; then
          count692=$(jq '.students | length' regis/data/2025_summer_msds692.json)
          echo "üë• MSDS 692 students: $count692"
          total_students=$((total_students + count692))
          
          echo "üìã MSDS 692 students:"
          jq -r '.students[] | "  - " + .name + " (" + .username + ")"' regis/data/2025_summer_msds692.json | sort
          echo ""
        fi
        
        if [ -f "regis/data/2025_summer_msds696.json" ] && command -v jq >/dev/null 2>&1; then
          count696=$(jq '.students | length' regis/data/2025_summer_msds696.json)
          echo "üë• MSDS 696 students: $count696"
          total_students=$((total_students + count696))
          
          echo "ÔøΩ MSDS 696 students:"
          jq -r '.students[] | "  - " + .name + " (" + .username + ")"' regis/data/2025_summer_msds696.json | sort
          echo ""
        fi
        
        echo "üë• Total students processed: $total_students"
        echo ""
        
        # Count profile pages
        if [ -d "regis/profiles" ]; then
          profile_count=$(find regis/profiles -name "*.html" | wc -l)
          echo "üìÑ Profile pages generated: $profile_count"
        fi
        
        echo ""
        
        # Show URLs where profiles will be available
        echo "üåê Profile URLs (after GitHub Pages deployment):"
        if [ -d "regis/profiles" ]; then
          find regis/profiles -name "*.html" -exec basename {} .html \; | sort | while read username; do
            echo "  - https://gmujtaba.com/regis/profiles/$username.html"
          done
        fi
        
        echo ""
        echo "‚úÖ Sync completed successfully!"
        
    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå === SYNC FAILED ===" 
        echo "‚è∞ Failed at: $(date)"
        echo ""
        echo "üîç Check the logs above for error details"
        echo "üí° Common issues:"
        echo "  - PAT_TOKEN not set or expired"
        echo "  - Malformed markdown in student profiles"
        echo "  - Missing required files"
        echo "  - Network connectivity issues"
        echo ""
        echo "üõ†Ô∏è  To fix:"
        echo "  1. Check repository secrets (PAT_TOKEN)"
        echo "  2. Validate student markdown files"
        echo "  3. Re-run the workflow"