name: Create Student Folders

on:
  workflow_dispatch:
    inputs:
      csv_file:
        description: 'CSV file to process (e.g., 2025_Summer_MSDS692.csv)'
        required: false
        type: string
        default: ''
  push:
    paths:
      - '*.csv'
      - 'data/*.csv'
    branches: [ main ]

permissions:
  contents: write
  issues: write

jobs:
  create-student-folders:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          ~/.local/lib/python*/site-packages
        key: ${{ runner.os }}-python-csv-deps-${{ hashFiles('.github/workflows/create-folders.yml') }}
        restore-keys: |
          ${{ runner.os }}-python-csv-deps-
          ${{ runner.os }}-python-deps-
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas PyYAML
        
    - name: Auto-detect CSV files to process
      if: github.event.inputs.csv_file == ''
      run: |
        echo "ğŸ” Auto-detecting CSV files..."
        
        # Look for CSV files in root and data/ directory
        csv_files=$(find . -maxdepth 2 -name "*.csv" -type f | grep -E "(2024|2025|2026).*MSDS" | head -3)
        
        if [ -z "$csv_files" ]; then
          echo "ğŸ“„ No CSV files found matching pattern YYYY_*_MSDS*.csv"
          echo "â„¹ï¸  Expected format: 2025_Summer_MSDS692.csv or 2025_Fall_MSDS696.csv"
          exit 0
        else
          echo "ğŸ“Š Found CSV files to process:"
          echo "$csv_files"
          
          # Process each CSV file
          for csv_file in $csv_files; do
            echo ""
            echo "ğŸ”„ Processing: $csv_file"
            python scripts/process_csv.py "$csv_file" --base-path .
            
            if [ $? -eq 0 ]; then
              echo "âœ… Successfully processed: $csv_file"
            else
              echo "âŒ Failed to process: $csv_file"
            fi
          done
        fi
        
    - name: Process specific CSV file (manual trigger)
      if: github.event.inputs.csv_file != ''
      run: |
        csv_file="${{ github.event.inputs.csv_file }}"
        echo "ğŸ”„ Processing manually specified CSV file: $csv_file"
        
        if [ -f "$csv_file" ]; then
          python scripts/process_csv.py "$csv_file" --base-path .
          
          if [ $? -eq 0 ]; then
            echo "âœ… Successfully processed: $csv_file"
          else
            echo "âŒ Failed to process: $csv_file"
            exit 1
          fi
        else
          echo "âŒ CSV file not found: $csv_file"
          echo "â„¹ï¸  Make sure the file exists and path is correct"
          echo "â„¹ï¸  Example: 2025_Summer_MSDS692.csv"
          exit 1
        fi
        
    - name: Verify created folders
      run: |
        echo ""
        echo "ğŸ“‹ === FOLDER CREATION SUMMARY ==="
        
        # Count student folders created
        if [ -d "data" ]; then
          folder_count=$(find data/ -type d -mindepth 2 -maxdepth 2 | wc -l)
          echo "ğŸ“ Student folders created: $folder_count"
          
          # List course folders
          echo ""
          echo "ğŸ“š Course folders:"
          find data/ -type d -mindepth 1 -maxdepth 1 | sed 's|data/||' | sort
          
          # Show sample student folders
          echo ""
          echo "ğŸ‘¥ Sample student folders:"
          find data/ -type d -mindepth 2 -maxdepth 2 | head -5 | while read folder; do
            username=$(basename "$folder")
            course=$(dirname "$folder" | sed 's|data/||')
            echo "  - $username ($course)"
          done
          
          if [ $folder_count -gt 5 ]; then
            echo "  ... and $((folder_count - 5)) more students"
          fi
          
          echo ""
          echo "ğŸ“‹ Students can now:"
          echo "  1. Navigate to their folder: data/COURSE/username/"
          echo "  2. Edit their profile.md file"
          echo "  3. Upload avatar.jpg (profile photo)"
          echo "  4. Add reports/ and presentations/ files"
          echo "  5. Commit and push changes"
          echo ""
          echo "ğŸš€ Next: Student updates will trigger portfolio generation"
          
        else
          echo "âš ï¸  No data directory found - no student folders were created"
        fi
        
    - name: Commit new student folders
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - Student Folder Creation"
        
        # Add all new student folders and files
        git add data/
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "ğŸ“ No new student folders to commit"
        else
          # Count the changes
          new_folders=$(git diff --staged --name-only | grep -E "data/.*/.*/profile\.md$" | wc -l)
          
          commit_message="ğŸ“ Create $new_folders student folders and templates"
          commit_message="$commit_message

Automatically generated from CSV upload:
- Created organized student folders
- Generated profile.md templates with student info
- Set up asset directories (reports/, presentations/)
- Ready for student customization

Students: Edit your profile.md and upload your files!
Generated at: $(date +'%Y-%m-%d %H:%M UTC')"

          git commit -m "$commit_message"
          git push origin main
          
          echo "âœ… Successfully committed $new_folders new student folders"
          echo ""
          echo "ğŸ“¬ Notify your students that their folders are ready!"
          echo "ğŸ“– Share the student guide: https://github.com/$(echo $GITHUB_REPOSITORY)/blob/main/README.md#-for-students-"
        fi
        
    - name: Generate notification for instructor
      run: |
        echo ""
        echo "ğŸ“§ === INSTRUCTOR NOTIFICATION ==="
        echo ""
        echo "Dear Instructor,"
        echo ""
        echo "âœ… Student folders have been successfully created from your CSV upload."
        echo ""
        
        if [ -d "data" ]; then
          folder_count=$(find data/ -type d -mindepth 2 -maxdepth 2 | wc -l)
          echo "ğŸ“Š Summary:"
          echo "   - $folder_count student folders created"
          echo "   - Profile templates generated with student information"
          echo "   - Directory structure ready for student assets"
          echo ""
          echo "ğŸ“‹ Next Steps:"
          echo "   1. Inform students their folders are ready"
          echo "   2. Share repository access with students"
          echo "   3. Provide students with the student guide"
          echo ""
          echo "ğŸ”— Student Guide: https://github.com/$(echo $GITHUB_REPOSITORY)#-for-students-"
          echo ""
          echo "ğŸ“ Students can find their folders at:"
          find data/ -type d -mindepth 2 -maxdepth 2 | head -3 | while read folder; do
            username=$(basename "$folder")
            course=$(dirname "$folder" | sed 's|data/||')
            echo "   - $username: data/$course/$username/"
          done
          
          if [ $folder_count -gt 3 ]; then
            echo "   - ... and $((folder_count - 3)) more"
          fi
        fi
        
        echo ""
        echo "ğŸš€ When students update their profiles, the portfolio sync will run automatically."
        echo ""
        echo "Happy teaching!"
        echo "Regis University Data Science Portfolio System"
        
    - name: Create issue for tracking (optional)
      if: success()
      continue-on-error: true
      run: |
        # Create a GitHub issue to track the new student batch
        if [ -d "data" ]; then
          folder_count=$(find data/ -type d -mindepth 2 -maxdepth 2 | wc -l)
          course_folders=$(find data/ -type d -mindepth 1 -maxdepth 1 | sed 's|data/||' | sort | tr '\n' ', ' | sed 's/,$//')
          
          issue_body="## ğŸ“ New Student Batch Created

**Created:** $(date +'%Y-%m-%d %H:%M UTC')
**Students:** $folder_count
**Courses:** $course_folders

### ğŸ“‹ Checklist for Instructor

- [ ] Notify students that folders are ready
- [ ] Share repository access with students  
- [ ] Provide student guide link
- [ ] Monitor student profile updates
- [ ] Review portfolios when complete

### ğŸ“ Student Folders Created

\`\`\`
$(find data/ -type d -mindepth 2 -maxdepth 2 | head -10)
\`\`\`

### ğŸ”— Resources

- [Student Guide](README.md#-for-students-)
- [Faculty Guide](../instructor-guide.html)
- [Portfolio Examples](../index.html)

*This issue was auto-created by the folder creation workflow.*"

          # Use GitHub CLI if available, otherwise skip
          if command -v gh >/dev/null 2>&1; then
            echo "$issue_body" | gh issue create --title "ğŸ“š Student Batch: $course_folders ($folder_count students)" --body-file -
            echo "ğŸ“ Created tracking issue for this student batch"
          else
            echo "ğŸ“ GitHub CLI not available - skipping issue creation"
          fi
        fi